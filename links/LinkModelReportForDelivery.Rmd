---
title: "Link Characteristics that Promote Clicks"
author: "STATCOM"
output: pdf_document
---

<!-- ```{r setup, include=FALSE} -->
<!-- knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.align = 'center', fig.width = 5, fig.height = 3) -->
<!-- ``` -->

# Link Characteristics that Promote Clicks: Executive Summary

## Questions of Interest

* Which link characteristics (bolded, font size, font color, location within newsletter) lead to more clicks?
* Which topics mentioned in the links (e.g. animals, art, family, hunger) tend to attract clicks?

## Statistical Analysis

* Bar plots and scatter plots to visually display click response based on link characteristics
* Statistical model to examine how factors interact and support the trends shown in the plots
* Qualitative analysis on the words associated with a link

## Takeaways

* The location of the link in the newsletter affects how often it is clicked. Specifically, the further down the link is in the newsletter, the less likely it is to be clicked on. Therefore, we suggest placing the most important or time-sensitive links at the top of the newsletter.
* Links that are bolded get slightly more clicks than links that do not have bolded text.
* Links that are orange [Mandarin Orange (146, 46, 33), Tangerine (242, 136, 0) or (238, 135, 2), Orange Peel (255, 151, 9)], gray [Charcoal (67, 67, 67)], or blue [Denim (17, 85, 204), Danube (85, 142, 190)] colored get more clicks than other colors.
* Having the link address appear in the newsletter multiple times, whether as text or image links, increases the number of clicks. However, this effect is not significant, according to the model. 
* People tend to click on text links rather than image links. 
* Opportunities with baby chicks and sharing one's skills are significantly popular.

\newpage
# Link Characteristics that Promote Clicks: Report

In this report, we investigate the characteristics of links that make them more likely to be clicked on.

The rest of the report is organized as follows. First, we give a brief description of how the data was obtained and a synopsis of the assumptions we made to analyze the click data. Then, we introduce the features used in the model and analyze how click rates were affected by these features separately. Finally, we fit a statistical model to the data and interpret the results.

## Data Description
<!-- Files used were developed in the following scripts -->
<!-- link_characteristics/link_characteristics.R -->
<!-- stringlinks/link_words.py-->
<!-- activate-good-emails/initial_report/data_wrangling.R-->
<!-- Merging of files was done in merge_link_datasets.R -->

The data comes from a few sources: the CSV files generated from iContact and the plain-text and HTML source code of each of the newsletters. From the CSV files, we determine the unique number of times a link was clicked on. We define a unique click to be a unique combination of subscriber ID, newsletter date, and link; in other words, if a subscriber clicked on the same link from the same newsletter, we do not count that click. 

Additionally, we only know the click count for each link address, not the actual link, within a newsletter. Thus, if there are multiple links with the same address in a newsletter, we don't know how many clicks each of those separate links received. To alleviate this issue of duplicate addresses, we assume that the first text link with a given address received all the clicks associated with that address. We account for whether the address is duplicated in our model.

We identify the time of day the newsletter was sent and whether it was before or after the COVID-19 pandemic was declared (03/20/20) from the CSV files. The plain-text files are used to get the text associated with a link and an approximation of how far down the newsletter the link is, e.g. a link that is about half-way down the newsletter would be assigned 50%. Finally, we obtain style characteristics and whether the link was an image or had an image associated with it from the HTML source code.

<!-- We distinguish between unique links (those with addresses that appear only once) and duplicated links (those with addresses appearing multiple times) in our model.  -->

Below is a summary of the features we created for the text links:

1. Bolded: whether the link text is bolded.
2. Font Size: ranges from 10-48 point.
3. Font Color: 26 possible colors. See Appendix for RGB values.
4. Image Associated: indicator for whether there is an image within the newsletter with the same link address.
5. Hour: hour of when the newsletter was sent
6. COVID: indicator for whether the COVID-19 pandemic was underway
7. Location within document: cumulative percentage of the document prior to a link
8. Duplicate: indicator for whether the link address appears more than once in a newsletter

## Data Exploration

Before fitting any models to the data, we explore how the number of clicks a link address receives depends on the variables mentioned above. It is important to note that in doing this, we do not control for how many times a link address was used within the same newsletter. For each of the categorical variables, we graph the category and the average number of times a link of that category was clicked below.

<!-- We define the average number of times a link address was clicked as the number of times the link was uniquely clicked divided by the number of newsletters the link appeared in. -->

### All Links

The following barplots pertain to all links, whether they are text or images.

```{r, warning = FALSE}
########################################################################
# Create a simple model between the link characteristics and the click count

# see how the bar plots change when dividing by the number of contacts
########################################################################
library(ggplot2)
library(chron)
library(stats)
library(gamlss)

link_char_count <- read.csv("links/full_link_dataset.csv")

# Note that a missing click count actually indicates no clicks and not missing
link_char_count_date_clean <- link_char_count
link_char_count_date_clean[is.na(link_char_count$clicks),]$clicks <- 0

# correct the date sent column due to these "missing" click counts
date_map <- unique(link_char_count[is.na(link_char_count$date_sent) == FALSE, cbind('date', 'date_sent')])
colnames(date_map) <- c('date', 'date_sent_clean')
  # convert to datetime object
date_map$date_sent_clean <- strptime(date_map$date_sent_clean, "%m/%d/%y %H:%M:%S", tz = '')

  # Add in an hour variable
date_map$hour <- sapply(date_map$date_sent_clean, hours)

  # Add in a COVID-19 indicator
covid <- as.Date(strptime('03/12/20', '%m/%d/%y'))
date_map$covid_ind <- as.Date(strptime(date_map$date, '%m/%d/%y')) < covid

link_char_count_date_clean <- merge(link_char_count_date_clean, date_map)

# remove missing link numbers and duplicate entries
cond1 <- is.na(link_char_count_date_clean$link_num) == FALSE # Alvin: actually, doesn't appear to be any NA link nums
cond2 <- link_char_count_date_clean$dup_after_first == FALSE
link_char_count_clean <- link_char_count_date_clean[(cond1) & (cond2),]

# Add in a counter variable
link_char_count_clean$count = 1

link_char_count_clean$type <- rep(NA, nrow(link_char_count_clean))

# Split into image, text without image, and text with image
link_char_count_clean[link_char_count_clean$is_image,]$type = 'image' 
link_char_count_clean[link_char_count_clean$is_image == F,]$type = 'text'
# link_char_count_clean[(link_char_count_clean$is_image == FALSE) &
#                         (link_char_count_clean$image_assoc == FALSE),]$type = 'text only'
# link_char_count_clean[(link_char_count_clean$is_image == FALSE) &
#                         (link_char_count_clean$image_assoc == TRUE),]$type = 'text and image'

# Get the average number of times a link was clicked based on whether it was a picture or not
prop_df <- aggregate(cbind(clicks, count) ~ type, data = link_char_count_clean, FUN = sum)
prop_df$mean <- prop_df$clicks/prop_df$count
ggplot(data = prop_df, aes(x = type, y = mean)) + geom_bar(stat = 'identity') +
  labs(x = 'Type of Link', y = 'Average Number of Clicks')

```

<!-- In the bar plot above, the label 'image only' refers to links that only has a picture associated with it, 'text only' refers to links that only has text, and 'text and image' refers to links with both an image and associated text. -->

Text links are clicked on more often than pictures. However, because our model only examines text links, we cannot verify this trend with the model. 

```{r}
# Were people more or less active during COVID?
  # average number of times a link was clicked before and during COVID
prop_df <- aggregate(cbind(clicks, count) ~ covid_ind, data = link_char_count_clean, FUN = sum)
prop_df$mean <- prop_df$clicks/prop_df$count
ggplot(data = prop_df, aes(x = covid_ind, y = mean)) + geom_bar(stat = 'identity') +
  labs(x = 'During COVID?', y = 'Average Number of Clicks')
```

Based on the bar plot above, it seems COVID impacted how much subscribers choose to interact with the newsletters. This is not all that surprising given the challenges everyone was facing during the pandemic.

```{r}
  # average number of times a link was clicked, duplicated or not duplicated
prop_df <- aggregate(cbind(clicks, count) ~ dup, data = link_char_count_clean, FUN = sum)
prop_df$mean <- prop_df$clicks/prop_df$count
ggplot(data = prop_df, aes(x = dup, y = mean)) + geom_bar(stat = 'identity') +
  labs(x = 'Used More than Once in a Newsletter', y = 'Average Number of Clicks')
```

The above bar plot indicates that addresses that appear multiple times in a newsletter tend to be clicked on more often, as expected. Even so, this effect is not significant, according to the below model. 

<!-- The bar plot above indicates that links that were used multiple times in a newsletter were clicked more often. This is somewhat surprising since interested individuals may click the first link they come to, but the plot above suggests more exposure to the opportunity encourages participating. However, the model below suggests this may not be the case. -->



### Text Links

The following barplots pertain to only text links.

```{r}
# split data set to text links and image links
text_only <- link_char_count_clean[link_char_count_clean$type != 'image',]
image_only <- link_char_count_clean[link_char_count_clean$type == 'image',]
```

```{r}
# Whether or not it was bolded
prop_df <- aggregate(cbind(clicks, count) ~ bolded, data = text_only, FUN = sum)
prop_df$mean <- prop_df$clicks/prop_df$count
ggplot(data = prop_df, aes(x = bolded, y = mean)) + geom_bar(stat = 'identity') +
  labs(x = 'Bolded Link', y = 'Average Number of Clicks')
```

Based on the bar plot above, it appears that bolding the text associated with the link also increases the chance that someone clicks on it.

```{r, fig.width = 8, fig.height = 5}
# top 5 colors overall
prop_df <- aggregate(cbind(clicks, count) ~ color_name, data = text_only, FUN = sum)
prop_df$mean <- prop_df$clicks/prop_df$count
prop_df <- na.omit(prop_df)
top5 <- prop_df[order(-prop_df$mean),][1:8,]
ggplot(data = top5, aes(x = color_name, y = mean)) + geom_bar(stat = 'identity') +
  labs(x = 'Top 8 Colors Overall', y = 'Average Number of Clicks') + ylim(0, 120)
```

This bar plot focuses on the top eight most clicked-on text color choices, on average. See Appendix for RGB values.

Any color of orange seems to grab people's attention! Mandarin Orange only appeared in the newsletter promoting the Remote Volunteer Project: DIY Family Essentials Kits opportunity so it is tempting to think the large number of clicks this color received may have more to do with the highly-relatable project. However, this project was advertised in four different newsletters using links colored as cinnabar and falu red (both are different tints of red) and these links were not clicked on as often. While there are more factors at play than just the link color, the fact that the links advertising the same opportunity in red got fewer clicks suggests that a text color of orange is more impactful.

```{r}
# Font Size
prop_df <- aggregate(cbind(clicks, count) ~ font_size, data = text_only, FUN = sum)
prop_df$mean <- prop_df$clicks/prop_df$count
ggplot(data = prop_df, aes(x = font_size, y = mean)) + geom_point() +
  labs(x = 'Font Size', y = 'Average Number of Clicks') + geom_smooth()
```

Larger links seem to be clicked on more. However, according to the below model, this effect is not significant.

```{r}
# Location within document
prop_df <- aggregate(cbind(clicks, count) ~ doc_prop, data = text_only, FUN = sum)
prop_df$mean <- prop_df$clicks/prop_df$count
ggplot(data = prop_df, aes(x = doc_prop, y = mean)) + geom_point() +
  labs(x = 'Location within Document', y = 'Average Number of Clicks') + geom_smooth()
```

The further down the newsletter link is, the less likely it is to be clicked on. 



### Image Links

The following barplots pertain to only image links.

```{r}
# Image Width
prop_df <- aggregate(cbind(clicks, count) ~ image_width, data = image_only, FUN = sum)
prop_df$mean <- prop_df$clicks/prop_df$count
ggplot(data = prop_df, aes(x = image_width, y = mean)) + geom_point() +
  labs(x = 'Image Width', y = 'Average Number of Clicks') + geom_smooth()
```

The dimensions of the image is determined by the image width--the image height is adjusted automatically. According to the scatter plot, the image width doesn't appear to affect the click rate.



## Model Fitting

```{r, include= FALSE}
# these models don't have a variable for how many newsletters the link appeared in

# Look at the distribution of the number of clicks
ggplot(data = link_char_count_clean) + geom_histogram(aes(x = clicks))
click_dist <- aggregate(count~clicks, data = link_char_count_clean, FUN = sum)

# Look at the other variables
pairs(link_char_count_clean[c('clicks', 'doc_prop', 'font_size', 'hour')])

# Consider only links with text (text only or text and image)
text_only <- link_char_count_clean[link_char_count_clean$type != 'image',]
text_only <- text_only[c('clicks', 'doc_prop', 'bolded', 'color_name', 'font_size',
                         'hour', 'covid_ind', 'image_assoc', 'dup')]
text_only <- na.omit(text_only)

# separate model for the duplicated links; may be less reliable because of the duplication issue -- appealling reason for fitting a separate model
# check for interaction affects
text_lm <- lm(clicks ~ doc_prop + bolded + color_name + font_size + hour + covid_ind + image_assoc + dup,
              data = text_only)

plot(text_only$clicks, text_lm$fitted.values)
qqnorm(text_lm$residuals)
qqline(text_lm$residuals)

# transform the number of clicks
text_only$sqrt_click <- sqrt(text_only$clicks)

text_lm_sqrt <- lm(sqrt_click ~ doc_prop + bolded + color_name + font_size + hour + covid_ind + image_assoc 
                   + dup, data = text_only)

plot(text_only$sqrt_click, text_lm_sqrt$fitted.values)
qqnorm(text_lm_sqrt$residuals)
qqline(text_lm_sqrt$residuals)
# not terrible on the linear regression with the sqrt transformation of the clicks
# the tails are still a bit heavy though
# and a regression more geared towards count regression would be more appropriate.

summary(text_lm_sqrt)

# Check against a Poisson/Negative Binomial Link
text_glm <- glm(clicks ~ doc_prop + bolded + color_name + font_size + hour + covid_ind + image_assoc,
                family = quasipoisson(link = 'log'), data = text_only)

plot(text_only$clicks, text_glm$fitted.values)
```

We fit a zero-inflated beta regression model to uncover trends regarding the text links. This model does not include image links. 

<!-- We attempted to fit a linear regression, a Poisson regression, and a Negative Binomial regression to the click data with no success. However, we found that if we divided the number of clicks by the number of subscribers each newsletter was sent to, a zero-inflated beta regression worked quite well.  -->

The outcome variable of interest, the number of clicks, was standardized by dividing the click count by the number of subscribers the newsletter containing the link was sent to. The beta regression allows us to model proportion data (data that's bounded between zero and one, non-inclusive). The "zero-inflated" in the name refers to extending the beta regression to include observations with a value of zero (many links received no clicks). The zero-inflated beta regression fits three parameters: mu, sigma, and nu. The mu variable corresponds to the mean of the click proportion (relative to the number of subscribers) and is modeled in a similar manner to simple linear regression.

The variables in our model are the following: doc_prop, bolded, color_name, font_size, hour, covid_ind, image_assoc, and dup. "doc_prop" is the proportion down the document a link is; in other words, a link that is about halfway down a newsletter will be about 50%. "bolded" indicates whether a link was bolded. "color_name" is the color of the link as named by [https://www.color-blindness.com/color-name-hue/](https://www.color-blindness.com/color-name-hue/).

Below we give a histogram of click proportions and the fitted model parameters for mu. From Table 1 below, we see that the link's location in the document, whether the link is bolded, and the color of the link make a statistically significant difference on whether the link is clicked or not. Additionally, we see that the top eight colors shown above are also statistically significant, except for Tenne. Interestingly, the indicator for whether the link address is duplicated or not, nor the indicator for whether the link address has an image associated with it, are not significant in the model. 

Finally, the mu coefficients given in the table below are, unfortunately, uninterpretable in their raw form. Luckily, a transformation of these coefficients gives the odds ratio of each variable. For the variables that are statistically significant at or below the 0.01 level, we give the odds ratios in Table 2. As an example of how odds ratios are interpreted, the doc_prop odds ratio of 0.46 means that when the location of the link in the document increases by one percentage point, the odds of it being clicked is 0.46 times the odds of it being clicked in the original position. Overall, an odds ratio greater than one indicates a positive association and an odds ratio less than one indicates a negative association; note that these agree with the signs of the coefficients in Table 1.

```{r}
# divide the clicks by the number of subscribers given in weeklies1:contacts sent to
# fit a beta model
# load in data that contains the number of subscribers each time a newsletter was sent
load('initial_report/weeklies1.RData')

# Keep only the variables we care about
weeklies <-  weeklies1[c('datetime', 'contacts_sent_to')]

# Add in a date variable to match the link_char dataset and merge the datasets
weeklies$date2 <-  as.Date(weeklies$date)
link_char_count_clean$date2 <-  as.Date(link_char_count_clean$date_sent_clean)
link_counts_subs <-  merge(weeklies, link_char_count_clean, by = 'date2')

# Divide the clicks by the number of subscribers
link_counts_subs$click_prop <- link_counts_subs$clicks/link_counts_subs$contacts_sent_to

# Consider only links with text (text only or text and image)
text_only <- link_counts_subs[link_counts_subs$type != 'image',]
text_only <- text_only[c('click_prop', 'doc_prop', 'bolded', 'color_name', 'font_size',
                         'hour', 'covid_ind', 'image_assoc', 'dup')]
text_only <- na.omit(text_only)

# Histogram of the Click Proportion
ggplot(data = text_only, aes(click_prop)) + geom_histogram() + ylim(0,150) + labs(x = 'Click Proportion', y = 'Frequency') + ggtitle("Histogram of Click Proportions")
```

```{r, include = FALSE}
# Fitted model
mod1<-gamlss(click_prop ~ doc_prop + bolded + color_name + font_size + hour + covid_ind + image_assoc + dup,
             sigma.formula=~1, nu.formula=~1, family=BEZI, data = text_only)

# Check Diagnostics
#plot(mod1)
#summary(mod1) is used to obtain the table below
```

\begin{center}
\includegraphics{coef.png}
\end{center}

\begin{center}
\includegraphics{odds.png}
\end{center}

## Qualitative Text Analysis

Finally, we explored what words encouraged subscribers to click on a link by creating word clouds. The word clouds are composed of the capitalized words that were contained in each link. By focusing on capitalized words, we attempted to ignore most of the unimportant filler words. The size of the words corresponds to the proportion of unique clicks relative to the number of total clicks a newsletter obtained. Note that this is slightly different than the proportion of clicks defined above for the zero-inflated beta model.

The first word cloud below is for any links that were not social media for Activate Good.

\begin{center}
\includegraphics{UniqueLinksClean.png}
\end{center}

The second word cloud below is for links that were for opportunities as defined by the link containing "opportunity" in the address; these links correspond to volunteer opportunities for subscribers.

\begin{center}
\includegraphics{Opportunity_Only.png}
\end{center}

As we can see, opportunities with baby chicks and sharing one's skills are significantly popular compared to other opportunities!

\newpage

# Appendix (Color RGB Values and Opportunity Link Click Frequency Table)
Here we provide the RGB values for all of the colors that were present in the news letter links. The names were assigned according to [https://www.color-blindness.com/color-name-hue/](https://www.color-blindness.com/color-name-hue/).

```{r, echo = FALSE, warning= FALSE}
library(knitr)
color_names_rgb = read.table("links/color_names_rgb.tsv", skip=1)
kable(color_names_rgb, col.names="Color Names")
```
